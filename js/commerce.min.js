var stripe=Stripe("pk_live_51HEYLpLyY1lmZM1FermehCfuo1oZbBRivtQfNOQ0e80GWlsqzretVYR3TmwiBC2dRmKbPifyypLrAf1BTxNLIJMQ005e2U1JwZ",{apiVersion:"2022-11-15",});var elements=stripe.elements();var style={base:{color:"#32325d",fontFamily:'Poppins, sans-serif',fontSize:"15px",padding:' 10px',"::placeholder":{color:"#878cac",}},invalid:{fontFamily:'Poppins, sans-serif',color:"#fa755a",iconColor:"#fa755a",}};var card=elements.create("card",{style:style});var btnStyle={paymentRequestButton:{type:'buy',theme:'dark',height:'50px',borderRadius:'8px',},};$(document).ready(function(){const phoneValidationError=$('#i18n-validation-phone').text();const nameValidationError=$('#i18n-validation-too-long').text();$.validator.addMethod('phone_number',function(value,element){return this.optional(element)||/^\+?\d{1,4}?[-.\s]?\(?\d{1,3}?\)?[-.\s]?\d{1,4}[-.\s]?\d{1,4}[-.\s]?\d{1,9}$/.test(value);},phoneValidationError);$.validator.methods.email=function(value,element){return this.optional(element)||/^[\w-\.\d*]+@[\w\d]+(\.\w{2,4})$/.test(value);}
$.validator.addMethod('name',function(value,element){return this.optional(element)||value.length<=128;},nameValidationError);var toggleLoader=function(action=null){var loader=$('#paymentLoader');var loaderImg=loader.find('img');if(!action){if(loader.css('visibility')==='visible'){action='hide';}else{action='show';}}
if(action==='show'){loaderImg.attr('src',loaderImg.data('image-src'));loader.css('visibility','visible');}else{loader.css('visibility','hidden');}};var updatePaymentIntent=function(paymentForm,commerceLinkID,paymentIntentNumber){var cardError=$('#cardError'+commerceLinkID);var formData={'email':paymentForm.find('input[name="email"]').val(),'message':paymentForm.find('textarea[name="message"]').val(),'phone':paymentForm.find('input[name="phone"]').val(),'whatsapp':paymentForm.find('input[name="whatsapp"]').val(),'name':paymentForm.find('input[name="name"]').val()};$.ajax({type:'post',dataType:'json',contentType:'application/json',url:'/commerce/payment-intent/update/'+paymentIntentNumber+'/',data:JSON.stringify(formData),async:false,success:function(data){isSuccess=true;},error:function(data){if(data.responseJSON){var key=Object.keys(data.responseJSON)[0];cardError.text(data.responseJSON[key]);}
isSuccess=false;toggleLoader('hide');}});return isSuccess;}
var payWithCard=function(stripe,card,clientSecret,commerceLinkID,paymentIntentID,paymentIntentNumber,paymentForm){toggleLoader('show');var cardError=$('#cardError'+commerceLinkID);if(!updatePaymentIntent(paymentForm,paymentIntentID,paymentIntentNumber)){return false;}
stripe.confirmCardPayment(clientSecret,{payment_method:{card:card}}).then(function(result){if(result.error){var errorMessage='';if(result.error.code==='charge_invalid_parameter'){errorMessage='Can not confirm this payment right now.';}else{errorMessage=result.error.message;}
cardError.text(errorMessage);toggleLoader('hide');}else{$.ajax({type:'post',dataType:'json',contentType:'application/json',url:'/commerce/payment-confirm/',data:JSON.stringify({'payment_intent_id':paymentIntentID}),success:function(data){$('.data-entry-cc[data-id='+commerceLinkID+']').addClass('hidden');$('.payment-successful[data-id='+commerceLinkID+']').removeClass('hidden');var receiptURL='/commerce/order-details/'+data.number+'/';$('#showReceipt'+commerceLinkID).attr('href',receiptURL);toggleLoader('hide');var formSelector=$('#paymentForm'+commerceLinkID);formSelector.off('submit');},error:function(data){if(data.responseJSON){var key=Object.keys(data.responseJSON)[0];cardError.text(data.responseJSON[key]);}
toggleLoader('hide');}});}});};var paymentRequest;var commerceLinkID;let visitorCountry=$('#userWrapper').data('visitor_country');if($('.preview-commerce-link-item__component').is('[data-expanded="true"]')){$('.preview-commerce-link-item__component[data-expanded="true"]').find('.link-underlayer').addClass('hidden');}
$('.preview-commerce-link-item__component .title').click(function(){card.unmount();if(window.prButton){window.prButton.unmount();paymentRequest.off('paymentmethod');}
commerceLinkID=$(this).data('id');var formSelector=$('#paymentForm'+commerceLinkID);let is_expanded=$(this).parent().data('expanded');formSelector.off('submit');$('.up-commerce[data-id='+commerceLinkID+']').toggleClass('hidden');$(this).parent().find('.preview-content').toggleClass('hidden');$(this).parent().find('.link-underlayer[data-id='+commerceLinkID+']').toggleClass('hidden');$('.data-entry-cc').addClass('hidden');$('.payment-successful').addClass('hidden');$('.share-window').addClass('hidden');$('.amount-form').removeClass('hidden');$('.payment-form').removeClass('hidden');$('.title[data-id='+commerceLinkID+']').toggleClass('title-active');if(!$(this).hasClass("title-active")&&!is_expanded){$(this).parent().find('.commerce-icon-wrapper').css("transform","rotate(0deg)");$(this).parent().find('.commerce-icon-wrapper svg').css("fill","");}
else if($(this).hasClass("title-active")&&!is_expanded){$(this).parent().find('.commerce-icon-wrapper').css("transform","rotate(180deg)");$(this).parent().find('.commerce-icon-wrapper svg').css("fill","");}
if($(this).hasClass("title-active")&&is_expanded){$(this).parent().find('.commerce-icon-wrapper').css("transform","rotate(0deg)");$(this).parent().find('.commerce-icon-wrapper svg').css("fill","");}else if(!$(this).hasClass("title-active")&&is_expanded){$(this).parent().find('.commerce-icon-wrapper').css("transform","rotate(180deg)");}});$('.commerce-btn-up').click(function(){card.unmount();if(window.prButton){window.prButton.unmount();paymentRequest.off('paymentmethod');}
var commerceLinkID=$(this).parent().data('id');var formSelector=$('#paymentForm'+commerceLinkID);const is_expanded=$(this).data('expanded');formSelector.off('submit');$('.preview-commerce-link-item__component[data-id='+commerceLinkID+'] .preview-content').addClass('hidden');$(this).parent().addClass('hidden');$('.data-entry-cc').addClass('hidden');$('.payment-successful').addClass('hidden');$('.amount-form').removeClass('hidden');$('.preview-commerce-link-item__component[data-id='+commerceLinkID+'] .title').toggleClass('title-active');$('.commerce-icon-wrapper[data-id='+commerceLinkID+']').css("transform","rotate(0deg)");$('.commerce-icon-wrapper[data-id='+commerceLinkID+'] svg').css("fill","");$('.preview-commerce-link-item__component .link-underlayer[data-id='+commerceLinkID+']').toggleClass('hidden');if(is_expanded){$('.commerce-icon-wrapper[data-id='+commerceLinkID+']').css("transform","rotate(180deg)");$('.preview-commerce-link-item__component .link-underlayer[data-id='+commerceLinkID+']').removeClass('hidden');}});let len=0;let maxlength=200;$('.inp-msg').keyup(function(){len=this.value.length;if(len>maxlength){return false;}else if(len>0){$('.rest').html((maxlength-len)+' characters left');}else{$('.rest').html((maxlength)+' characters left');}});$('.rate').click(function(){var rateID=$(this).data('id');var value=$(this).data('value');var commerceLinkID=$(this).data('linkid');var input=$('input.inp-rate[data-linkid='+commerceLinkID+']');input.val(value);input.attr('data-rateid',rateID);$('.rate[data-linkid='+commerceLinkID+']').removeClass('active');$(this).addClass('active');$('.btn-continue[data-id='+commerceLinkID+']').prop('disabled',false);$('.btn-continue[data-id='+commerceLinkID+']').removeClass('disable');if(!value){$('.btn-continue[data-id='+commerceLinkID+']').addClass('disable');}});$(document).on('input','input.inp-rate',function(e){var commerceLinkID=$(this).data('linkid');var value=$(this).val();if(value&&parseInt(Number(value))){$('.btn-continue[data-id='+commerceLinkID+']').prop('disabled',false);$('.btn-continue[data-id='+commerceLinkID+']').removeClass('disable');}else if(!e.target.value){$('.btn-continue[data-id='+commerceLinkID+']').addClass('disable');$('.btn-continue[data-id='+commerceLinkID+']').prop('disabled',true);}else{$('.btn-continue[data-id='+commerceLinkID+']').prop('disabled',true).addClass('disable');}});$('.btn-shares').click(function(){var commerceLinkID=$(this).parent().parent().data('id');$('.payment-successful[data-id='+commerceLinkID+']').addClass('hidden');$('.share-window[data-id='+commerceLinkID+']').removeClass('hidden');});$('.btn-continue').click(function(){var commerceLinkID=$(this).data('id');const amount=$('input[data-linkid='+commerceLinkID+']').val();var currencyCode=$('.data-entry-cc[data-id='+commerceLinkID+']').data('currency_code').toLowerCase();let currencyAmount=amount+"00";$('.data-entry-cc[data-id='+commerceLinkID+'] .show-amount').text(amount);$('.data-entry-cc[data-id='+commerceLinkID+']').toggleClass('hidden');$('.amount-form[data-id='+commerceLinkID+']').toggleClass('hidden');$('.payment-form[data-id='+commerceLinkID+']').toggleClass('hidden');var cardElementID='#cardElement'+commerceLinkID;var paymentSubmitID='#paymentSubmit'+commerceLinkID;var cardErrorID='#cardError'+commerceLinkID;card.mount(cardElementID);card.on("change",function(event){if(event.empty){$(paymentSubmitID).addClass('disable');$(paymentSubmitID).prop('disabled',true);}else if(!event.empty){$(paymentSubmitID).removeClass('disable');$(paymentSubmitID).prop('disabled',false);}
$(cardErrorID).text(event.error?event.error.message:"");});var paymentForm=$('#paymentForm'+commerceLinkID);var formData={'commerce_link_id':commerceLinkID,'revenue_gross':amount,};$.ajax({type:'post',dataType:'json',contentType:'application/json',url:'/commerce/payment-intent/',data:JSON.stringify(formData),success:function(data){var clientSecret=data.stripe_client_secret;var paymentIntentID=data.payment_intent_id;var paymentIntentNumber=data.number;var formSelector=$('#paymentForm'+commerceLinkID);let emailRequired=$('.inp-email'+commerceLinkID).data('optional')===true?false:true;let phoneNumberRequired=$('.inp-phone'+commerceLinkID).data('optional')===true?false:true;let nameRequired=$('.inp-name'+commerceLinkID).data('optional')===true?false:true;let whatsappRequired=$('.inp-whatsapp'+commerceLinkID).data('optional')===true?false:true;let messageRequired=$('.inp-msg'+commerceLinkID).data('optional')===true?false:true;formSelector.on('submit',function(e){e.preventDefault(e);formSelector.validate({rules:{message:{maxlength:1000,required:messageRequired,},phone:{phone_number:true,required:phoneNumberRequired,},whatsapp:{phone_number:true,required:whatsappRequired},email:{email:true,required:emailRequired,},name:{required:nameRequired,}}});if(formSelector.valid()){payWithCard(stripe,card,clientSecret,commerceLinkID,paymentIntentID,paymentIntentNumber,paymentForm);}});if(!paymentRequest){paymentRequest=stripe.paymentRequest({country:`${visitorCountry}`,currency:`${currencyCode}`,total:{label:'Total',amount:parseInt(currencyAmount),},requestPayerName:true,requestPayerEmail:true,});}else{paymentRequest.update({currency:`${currencyCode}`,total:{label:'Total',amount:parseInt(currencyAmount),},})};if(!window.prButton){window.prButton=elements.create('paymentRequestButton',{paymentRequest,style:btnStyle,});}
(async(e)=>{const result=await paymentRequest.canMakePayment();const stripeBtn='#payment-request-button'+commerceLinkID;if(result){window.prButton.mount(stripeBtn);}else{$(window.prButton).hide();}})();paymentRequest.on('paymentmethod',async(ev)=>{const{paymentIntent,error:confirmError}=await stripe.confirmCardPayment(clientSecret,{payment_method:ev.paymentMethod.id},{handleActions:false},);if(confirmError){ev.complete('fail');}else{$.ajax({type:'post',dataType:'json',contentType:'application/json',url:'/commerce/payment-confirm/',data:JSON.stringify({'payment_intent_id':paymentIntentID}),success:function(data){$('.data-entry-cc[data-id='+commerceLinkID+']').addClass('hidden');$('.payment-successful[data-id='+commerceLinkID+']').removeClass('hidden');var receiptURL='/commerce/order-details/'+data.number+'/';$('#showReceipt'+commerceLinkID).attr('href',receiptURL);var formSelector=$('#paymentForm'+commerceLinkID);formSelector.off('submit');},error:function(data){if(data.responseJSON){var key=Object.keys(data.responseJSON)[0];cardError.text(data.responseJSON[key]);}
toggleLoader('hide');}});ev.complete('success');}});},error:function(data){if(data.responseJSON){var key=Object.keys(data.responseJSON)[0];$(cardErrorID).text(data.responseJSON[key]);}}});});});